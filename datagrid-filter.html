<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>jQuery EasyUI Demo</title>
    <link rel="stylesheet" type="text/css" href="css/easyui.css">
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.easyui.min.js"></script>
    <style>
        .icon-filter {
            background: url('css/images/filter.png') no-repeat center center;
        }
    </style>
    <script>
        //测试数据
        var data = [
            {
                "productid": "FI-SW-01",
                "productname": "Koi",
                "unitcost": 10.00,
                "status": "P",
                "listprice": 36.50,
                "attr1": "Large",
                "itemid": "EST-1"
            },
            {
                "productid": "K9-DL-01",
                "productname": "Dalmation",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 18.50,
                "attr1": "Spotted Adult Female",
                "itemid": "EST-10"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 38.50,
                "attr1": "Venomless",
                "itemid": "EST-11"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 26.50,
                "attr1": "Rattleless",
                "itemid": "EST-12"
            },
            {
                "productid": "RP-LI-02",
                "productname": "Iguana",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 35.50,
                "attr1": "Green Adult",
                "itemid": "EST-13"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 158.50,
                "attr1": "Tailless",
                "itemid": "EST-14"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 83.50,
                "attr1": "With tail",
                "itemid": "EST-15"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 23.50,
                "attr1": "Adult Female",
                "itemid": "EST-16"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 89.50,
                "attr1": "Adult Male",
                "itemid": "EST-17"
            },
            {
                "productid": "AV-CB-01",
                "productname": "Amazon Parrot",
                "unitcost": 92.00,
                "status": "N",
                "listprice": 63.50,
                "attr1": "Adult Male",
                "itemid": "EST-18"
            },
            {
                "productid": "FI-SW-01",
                "productname": "Koi",
                "unitcost": 10.00,
                "status": "P",
                "listprice": 36.50,
                "attr1": "Large",
                "itemid": "EST-1"
            },
            {
                "productid": "K9-DL-01",
                "productname": "Dalmation",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 18.50,
                "attr1": "Spotted Adult Female",
                "itemid": "EST-10"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 38.50,
                "attr1": "Venomless",
                "itemid": "EST-11"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 26.50,
                "attr1": "Rattleless",
                "itemid": "EST-12"
            },
            {
                "productid": "RP-LI-02",
                "productname": "Iguana",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 35.50,
                "attr1": "Green Adult",
                "itemid": "EST-13"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 158.50,
                "attr1": "Tailless",
                "itemid": "EST-14"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 83.50,
                "attr1": "With tail",
                "itemid": "EST-15"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 23.50,
                "attr1": "Adult Female",
                "itemid": "EST-16"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 89.50,
                "attr1": "Adult Male",
                "itemid": "EST-17"
            },
            {
                "productid": "AV-CB-01",
                "productname": "Amazon Parrot",
                "unitcost": 92.00,
                "status": "N",
                "listprice": 63.50,
                "attr1": "Adult Male",
                "itemid": "EST-18"
            },
            {
                "productid": "FI-SW-01",
                "productname": "Koi",
                "unitcost": 10.00,
                "status": "P",
                "listprice": 36.50,
                "attr1": "Large",
                "itemid": "EST-1"
            },
            {
                "productid": "K9-DL-01",
                "productname": "Dalmation",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 18.50,
                "attr1": "Spotted Adult Female",
                "itemid": "EST-10"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 38.50,
                "attr1": "Venomless",
                "itemid": "EST-11"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 26.50,
                "attr1": "Rattleless",
                "itemid": "EST-12"
            },
            {
                "productid": "RP-LI-02",
                "productname": "Iguana",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 35.50,
                "attr1": "Green Adult",
                "itemid": "EST-13"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 158.50,
                "attr1": "Tailless",
                "itemid": "EST-14"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 83.50,
                "attr1": "With tail",
                "itemid": "EST-15"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 23.50,
                "attr1": "Adult Female",
                "itemid": "EST-16"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 89.50,
                "attr1": "Adult Male",
                "itemid": "EST-17"
            },
            {
                "productid": "AV-CB-01",
                "productname": "Amazon Parrot",
                "unitcost": 92.00,
                "status": "N",
                "listprice": 63.50,
                "attr1": "Adult Male",
                "itemid": "EST-18"
            },
            {
                "productid": "FI-SW-01",
                "productname": "Koi",
                "unitcost": 10.00,
                "status": "P",
                "listprice": 36.50,
                "attr1": "Large",
                "itemid": "EST-1"
            },
            {
                "productid": "K9-DL-01",
                "productname": "Dalmation",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 18.50,
                "attr1": "Spotted Adult Female",
                "itemid": "EST-10"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 38.50,
                "attr1": "Venomless",
                "itemid": "EST-11"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 26.50,
                "attr1": "Rattleless",
                "itemid": "EST-12"
            },
            {
                "productid": "RP-LI-02",
                "productname": "Iguana",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 35.50,
                "attr1": "Green Adult",
                "itemid": "EST-13"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 158.50,
                "attr1": "Tailless",
                "itemid": "EST-14"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 83.50,
                "attr1": "With tail",
                "itemid": "EST-15"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 23.50,
                "attr1": "Adult Female",
                "itemid": "EST-16"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 89.50,
                "attr1": "Adult Male",
                "itemid": "EST-17"
            },
            {
                "productid": "AV-CB-01",
                "productname": "Amazon Parrot",
                "unitcost": 92.00,
                "status": "N",
                "listprice": 63.50,
                "attr1": "Adult Male",
                "itemid": "EST-18"
            },
            {
                "productid": "FI-SW-01",
                "productname": "Koi",
                "unitcost": 10.00,
                "status": "P",
                "listprice": 36.50,
                "attr1": "Large",
                "itemid": "EST-1"
            },
            {
                "productid": "K9-DL-01",
                "productname": "Dalmation",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 18.50,
                "attr1": "Spotted Adult Female",
                "itemid": "EST-10"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 38.50,
                "attr1": "Venomless",
                "itemid": "EST-11"
            },
            {
                "productid": "RP-SN-01",
                "productname": "Rattlesnake",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 26.50,
                "attr1": "Rattleless",
                "itemid": "EST-12"
            },
            {
                "productid": "RP-LI-02",
                "productname": "Iguana",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 35.50,
                "attr1": "Green Adult",
                "itemid": "EST-13"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 158.50,
                "attr1": "Tailless",
                "itemid": "EST-14"
            },
            {
                "productid": "FL-DSH-01",
                "productname": "Manx",
                "unitcost": 12.00,
                "status": "P",
                "listprice": 83.50,
                "attr1": "With tail",
                "itemid": "EST-15"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 5.00,
                "status": "P",
                "listprice": 23.50,
                "attr1": "Adult Female",
                "itemid": "EST-16"
            },
            {
                "productid": "FL-DLH-02",
                "productname": "Persian",
                "unitcost": 12.00,
                "status": "N",
                "listprice": 89.50,
                "attr1": "Adult Male",
                "itemid": "EST-17"
            },
            {
                "productid": "AV-CB-01",
                "productname": "Amazon Parrot",
                "unitcost": 323.00,
                "status": "N",
                "listprice": 63.50,
                "attr1": "Adult Male",
                "itemid": "EST-18"
            }
        ];
        //保存所有的filter
        var filterColumns=[];
        //清除已有高亮
        function clearHighlight(i, field){
            var ele=$('tr[datagrid-row-index="' + i + '"] td[field="'+field+'"] div');
            var str=ele.html();
            str=str.replace('<span style="color:red">','');
            str=str.replace('</span>','');
            ele.html(str);
        }
        $.extend($.fn.datagrid.defaults.view, {
            onAfterRender: function (target) {
                var dc = $.data(target, 'datagrid').dc;
                if (dc.header2.find('[filter="true"]').length == 0) {
                    var header = dc.header1; //固定列表头
                    var header2 = dc.header2; // 常规列表头
                    var filterRow = $('<tr></tr>');
                    var opts = $.data(target, 'datagrid').options;
                    var columns = opts.columns;
                    var frozenColumns = opts.frozenColumns;

                    if (frozenColumns[0]) {
                        $.each(frozenColumns[0], function () {
                            if (!this.checkbox) {
                                var w = header.find('[field="' + this.field + '"] > div').width();

                                filterRow.append('<td><input type="text" style="width:' + w + 'px"/><div class="icon-filter" style="display:inline-block;width:10px;height:10px;"></div></td>');
                            }
                            else {
                                header.find('.datagrid-header-check').parent().attr('rowspan', 2)
                            }
                        });
                    }
                    header.find('tbody').append(filterRow);
                    filterRow = $('<tr filter="true"></tr>');

                    $.each(columns[0], function () {
                        var w = header2.find('[field="' + this.field + '"] > div').width();
                        //暂时只考虑输入text情况
                        filterRow.append('<td><input type="text" field="' + this.field + '" style="width:' + (w - 10) + 'px"/><div class="icon-filter" style="display:inline-block;width:10px;height:10px;"></div></td>');
                    });

                    header2.find('tbody').append(filterRow);

                    var dgData = $(target).datagrid('getRows');

                    header2.find('input[type=text]').each(function () {
                        $(this).on('input', function () {
                            var f = $(this).attr('field'),v = $(this).val();
                            var flag=false;
                            for(var i=0;i<filterColumns.length;i++){
                                if(filterColumns[i].field==f) {
                                    filterColumns[i].value = v;
                                    flag=true;
                                    break;
                                }
                            }
                            if(!flag)
                                filterColumns.push({field:f,value:v});
                            for(var idx=0;idx<filterColumns.length;idx++) {
                                var field=filterColumns[idx].field;
                                var value=filterColumns[idx].value;
                                //数字大小比较
                                if (dgData[0] && typeof dgData[0][field] == 'number' && (value.charAt(0) > '9' || value.charAt(0) < '0')) {
                                    var optype = -1;
                                    if (value.startsWith('>='))
                                        optype = 1;
                                    else if (value.startsWith('<='))
                                        optype = 2;
                                    else if (value.startsWith('!='))
                                        optype = 3;
                                    else if (value.startsWith('>'))
                                        optype = 4;
                                    else if (value.startsWith('<'))
                                        optype = 5;
                                    else if (value.startsWith('='))
                                        optype = 6;
                                    if (optype > 0 && optype <= 3 && value.length >= 2)
                                        value = value.substring(2);
                                    else if (optype > 3 && value.length >= 1)
                                        value = value.substring(1);
                                    if (value == '') {
                                        for (var i = 0; i < dgData.length; i++) {
                                            clearHighlight(i, field);
                                            if(idx==0||(idx>0 && $('tr[datagrid-row-index="' + i + '"]').is(':visible')))
                                                $('tr[datagrid-row-index="' + i + '"]').show();
                                        }
                                        continue;
                                    }
                                    var reg = /^(-?\d+)(\.\d+)?$/;
                                    if (optype > 0 && reg.test(value) && (value = parseInt(value))) {
                                        for (var i = 0; i < dgData.length; i++) {
                                            clearHighlight(i, field);
                                            if(idx==0||(idx>0 && $('tr[datagrid-row-index="' + i + '"]').is(':visible'))) {
                                                if (optype == 1) {
                                                    if (dgData[i][field] >= value)
                                                        $('tr[datagrid-row-index="' + i + '"]').show();
                                                    else
                                                        $('tr[datagrid-row-index="' + i + '"]').hide();
                                                }
                                                else if (optype == 2) {
                                                    if (dgData[i][field] <= value)
                                                        $('tr[datagrid-row-index="' + i + '"]').show();
                                                    else
                                                        $('tr[datagrid-row-index="' + i + '"]').hide();
                                                }
                                                else if (optype == 3) {
                                                    if (dgData[i][field] != value)
                                                        $('tr[datagrid-row-index="' + i + '"]').show();
                                                    else
                                                        $('tr[datagrid-row-index="' + i + '"]').hide();
                                                }
                                                else if (optype == 4) {
                                                    if (dgData[i][field] > value)
                                                        $('tr[datagrid-row-index="' + i + '"]').show();
                                                    else
                                                        $('tr[datagrid-row-index="' + i + '"]').hide();
                                                }
                                                else if (optype == 5) {
                                                    if (dgData[i][field] < value)
                                                        $('tr[datagrid-row-index="' + i + '"]').show();
                                                    else
                                                        $('tr[datagrid-row-index="' + i + '"]').hide();
                                                }
                                                else if (optype == 6) {
                                                    if (dgData[i][field] == value)
                                                        $('tr[datagrid-row-index="' + i + '"]').show();
                                                    else
                                                        $('tr[datagrid-row-index="' + i + '"]').hide();
                                                }
                                            }
                                        }
                                        continue;
                                    }
                                    else {
                                        alert('数字仅支持“>”,“<”,“=”,“!=”,“>=”,“<=”过滤操作');
                                        for (var i = 0; i < dgData.length; i++) {
                                            clearHighlight(i, field);
                                            $('tr[datagrid-row-index="' + i + '"]').show();
                                        }
                                        continue;
                                    }
                                }
                                if (value != '') {
                                    for (var i = 0; i < dgData.length; i++) {
                                        clearHighlight(i, field);
                                        if(idx==0||(idx>0 && $('tr[datagrid-row-index="' + i + '"]').is(':visible'))) {
                                            var index = String(dgData[i][field]).indexOf(value);
                                            if (index == -1)
                                                $('tr[datagrid-row-index="' + i + '"]').hide();
                                            else {
                                                $('tr[datagrid-row-index="' + i + '"]').show();
                                                var ele = $('tr[datagrid-row-index="' + i + '"] td[field="' + field + '"] div');
                                                var str = ele.html();
                                                str = str.substr(0, index) + '<span style="color:red">' + value + '</span>' + str.substring(index + value.length);
                                                ele.html(str);
                                            }
                                        }
                                    }
                                }
                                else {
                                    for (var i = 0; i < dgData.length; i++) {
                                        clearHighlight(i, field);
                                        if(idx==0||(idx>0 && $('tr[datagrid-row-index="' + i + '"]').is(':visible')))
                                            $('tr[datagrid-row-index="' + i + '"]').show();
                                    }
                                }
                            }
                        });
                    })
                }

            }
        });
        $(function () {
            $('#dg').datagrid({
                singleSelect: true,
                data: data.slice(0, 20), pagination: true,
                pageSize: 20, rownumbers: true,
            });
            //分页
            var pager = $("#dg").datagrid("getPager");
            pager.pagination({
                total: data.length,
                onSelectPage: function (pageNo, pageSize) {
                    var start = (pageNo - 1) * pageSize;
                    var end = start + pageSize;
                    $("#dg").datagrid("loadData", data.slice(start, end));
                    pager.pagination('refresh', {
                        total: data.length,
                        pageNumber: pageNo
                    });
                    //清空filter row
                    $('tr[filter="true"] input[type="text"]').val('');
                }
            });
        });
    </script>
</head>
<body>
<h1>DataGrid Filter Row</h1>

<table id="dg" title="DataGrid" style="width:700px;height:850px">
    <thead>
    <tr>
        <th data-options="field:'itemid',width:80">Item ID</th>
        <th data-options="field:'productid',width:100">Product</th>
        <th data-options="field:'listprice',width:80,align:'right'">List Price</th>
        <th data-options="field:'unitcost',width:80,align:'right'">Unit Cost</th>
        <th data-options="field:'attr1',width:250">Attribute</th>
        <th data-options="field:'status',width:60,align:'center'">
            Status
        </th>
    </tr>
    </thead>
</table>
</body>
</html>
